# CDEK Widget –Ω–∞ Amvera (single container: Nginx + PHP-FPM)

–ì–æ—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ **Amvera** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Docker-–æ–±—Ä–∞–∑–∞. –û–±—Ä–∞–∑ –≤–Ω—É—Ç—Ä–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç nginx –∏ php-fpm (—á–µ—Ä–µ–∑ supervisord), –æ—Ç–¥–∞—ë—Ç —Ñ—Ä–æ–Ω—Ç –∏ `service.php` –Ω–∞ –æ–¥–Ω–æ–º –¥–æ–º–µ–Ω–µ ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è Telegram WebApp.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Amvera

–ü—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Amvera —á–µ—Ä–µ–∑ —Ñ–∞–π–ª `amvera.yaml`:

```yaml
meta:
  environment: php
  toolchain:
    name: php
    version: 8.2

build:
  packages:
    - nginx
    - supervisor
    - curl
    - gettext
  php_extensions:
    - bcmath

run:
  command: ["supervisord", "-c", "/etc/supervisord.conf"]
  port: 8080
  env:
    PORT: "8080"
    ALLOWED_ORIGIN: "*"
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –Ω–∞ Amvera

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:**
   - –ó–∞–º–µ–Ω–∏—Ç–µ `app/php/service_core.php` –Ω–∞ **–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π** —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–∞–π–ª –∏–∑ CDEK Widget 3.x
   - –í—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π **Yandex Maps JS API key** –≤ `app/public/config.json` (–æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø–æ Referrer)
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ CDEK –≤ `app/php/service_core.php`

2. **–î–µ–ø–ª–æ–π –Ω–∞ Amvera:**
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (GitHub, GitLab, Bitbucket)
   - –í –ø–∞–Ω–µ–ª–∏ Amvera —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
   - –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
   - Amvera –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç `amvera.yaml` –∏ `Dockerfile`
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
     - `ALLOWED_ORIGIN=https://<–≤–∞—à-–¥–æ–º–µ–Ω>.amvera.ru`
     - `CDEK_USE_TEST_API=true` (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
     - (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `CDEK_ACCOUNT`, `CDEK_KEY`

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Bot:**
   - –£–∫–∞–∂–∏—Ç–µ URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Amvera –≤ BotFather –∫–∞–∫ WebApp URL
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–±–æ—Ç—É –≤–∏–¥–∂–µ—Ç–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
‚îú‚îÄ‚îÄ amvera.yaml              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Amvera
‚îú‚îÄ‚îÄ Dockerfile               # Docker –æ–±—Ä–∞–∑ –¥–ª—è Amvera
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ public/              # –§—Ä–æ–Ω—Ç–µ–Ω–¥ (HTML, CSS, JS)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ script.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ style.css
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.json
‚îÇ   ‚îî‚îÄ‚îÄ php/
‚îÇ       ‚îî‚îÄ‚îÄ service_core.php # PHP —Å–µ—Ä–≤–∏—Å –¥–ª—è CDEK API
‚îî‚îÄ‚îÄ docker/
    ‚îî‚îÄ‚îÄ nginx-php/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –∏ supervisord
        ‚îú‚îÄ‚îÄ nginx.conf.template
        ‚îú‚îÄ‚îÄ supervisord.conf
        ‚îî‚îÄ‚îÄ entrypoint.sh
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–û–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**: nginx + php-fpm —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —á–µ—Ä–µ–∑ supervisord
- **CORS –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- **Telegram WebApp**: –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Telegram WebApp SDK
- **CDEK Widget v3**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –≤–∏–¥–∂–µ—Ç–æ–º –°–î–≠–ö
- **Amvera –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Amvera

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `PORT` | –ü–æ—Ä—Ç –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ | `8080` |
| `ALLOWED_ORIGIN` | –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã –¥–ª—è CORS | `*` |
| `CDEK_USE_TEST_API` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π API CDEK | `false` |
| `CDEK_ACCOUNT` | –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ CDEK (–ª–æ–≥–∏–Ω) | - |
| `CDEK_KEY` | –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ CDEK (–ø–∞—Ä–æ–ª—å) | - |

–£–¥–∞—á–∏! üöÄ
